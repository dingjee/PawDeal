# Negotiation System MEMO

## 决策记录

### 2026-01-16: 状态机重构 - 主动权转移机制

**问题**: 原有流程中，玩家拒绝 AI 反提案后，下回合仍是玩家先手提案，不符合真实谈判逻辑。

**选择**: 方案 A - 主动权转移机制

**设计**:
- 玩家提案被拒 → AI 获得主动权（生成反提案）
- AI 反提案被玩家拒绝 → AI 继续调整（主动权仍在 AI）
- 玩家选择"修改提案" → 主动权转移回玩家

**新状态枚举**:
```
IDLE            - 空闲/未开始
PLAYER_TURN     - 玩家回合：编辑和提交提案
AI_EVALUATE     - AI 评估玩家提案中
AI_TURN         - AI 回合：生成/调整反提案  ← 新增
PLAYER_EVALUATE - 玩家评估 AI 提案中        ← 新增
PLAYER_REACTION - 玩家选择反应
GAME_END        - 游戏结束
```

**玩家反应类型**:
```
ACCEPT     - 接受 AI 提案
REJECT     - 拒绝（AI 需再次调整）
MODIFY     - 玩家要求修改自己的提案
WALK_AWAY  - 离场
```

**AI 让步机制**:
- 每被玩家拒绝一次，AI 临时降低 BATNA（更容易妥协）
- 连续被拒绝 3 次，AI 可能选择放弃谈判

**回合定义**: 每次提案或响应算 1 回合

---

### 2026-01-16: AI 反提案显示问题修复

**问题**: AI 生成反提案后，UI 没有更新显示建议内容。

**原因**: 
1. `ai_deck` 未初始化（AI 没有卡牌库）
2. UI 未监听 `counter_offer_generated` 信号

**修复**:
1. 添加 `_init_ai_deck()` 初始化 AI 卡牌库
2. 连接 `counter_offer_generated` 信号
3. 添加 `_update_counter_offer_display()` 显示反提案
4. 用颜色标记建议添加（绿色）/移除（红色）的卡牌

---

### 2026-01-16: 卡牌标签歧义修复

**问题**: "我方/对方"标签从AI视角定义，对玩家造成混淆。

**选择**: 方案 B - 使用中立命名

**修复**: 改为"AI方"和"玩家"标签

---

## Phase 2 升级路径

1. **AI 战术选择**: AI 可以选择不同的谈判姿态（威胁、示弱等）
2. **情绪系统**: 玩家的反应影响 AI 的情绪/耐心值
3. **历史记忆**: AI 记住玩家之前的行为模式，调整策略
4. **多轮博弈**: 整局游戏结束后的胜负/关系累积
